# Crossplane Composition for CosmosApp
# Maps the CosmosApp API to underlying Azure and Kubernetes resources
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: cosmosapp-azure
  labels:
    crossplane.io/xrd: xcosmosapps.platform.example.com
    provider: azure
spec:
  compositeTypeRef:
    apiVersion: platform.example.com/v1alpha1
    kind: XCosmosApp

  writeConnectionSecretsToNamespace: crossplane-system

  resources:
    # ============================================================
    # 1. User-Assigned Managed Identity
    # ============================================================
    - name: managed-identity
      base:
        apiVersion: managedidentity.azure.upbound.io/v1beta1
        kind: UserAssignedIdentity
        spec:
          forProvider:
            location: eastus
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-identity"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.location
          toFieldPath: spec.forProvider.location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.clientId
          toFieldPath: status.identityClientId
      connectionDetails:
        - name: identityClientId
          fromFieldPath: status.atProvider.clientId

    # ============================================================
    # 2. Federated Identity Credential
    # ============================================================
    - name: federated-credential
      base:
        apiVersion: managedidentity.azure.upbound.io/v1beta1
        kind: FederatedIdentityCredential
        spec:
          forProvider:
            audience:
              - api://AzureADTokenExchange
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-federated"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.parentIdSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.oidcIssuerUrl
          toFieldPath: spec.forProvider.issuer
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: metadata.labels[crossplane.io/claim-namespace]
              - fromFieldPath: spec.appName
            strategy: string
            string:
              fmt: "system:serviceaccount:%s:%s-sa"
          toFieldPath: spec.forProvider.subject
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name

    # ============================================================
    # 3. Cosmos DB Account
    # ============================================================
    - name: cosmos-account
      base:
        apiVersion: cosmosdb.azure.upbound.io/v1beta1
        kind: Account
        spec:
          forProvider:
            offerType: Standard
            kind: GlobalDocumentDB
            publicNetworkAccessEnabled: false
            geoLocation:
              - failoverPriority: 0
                zoneRedundant: false
            consistencyPolicy:
              - consistencyLevel: Session
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-cosmos"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.location
          toFieldPath: spec.forProvider.location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.location
          toFieldPath: spec.forProvider.geoLocation[0].location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.consistencyLevel
          toFieldPath: spec.forProvider.consistencyPolicy[0].consistencyLevel
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name
        - type: ToCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.cosmosAccountName
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.endpoint
          toFieldPath: status.cosmosEndpoint
      connectionDetails:
        - name: cosmosAccountName
          fromFieldPath: metadata.name
        - name: cosmosEndpoint
          fromFieldPath: status.atProvider.endpoint

    # ============================================================
    # 4. Cosmos SQL Database
    # ============================================================
    - name: cosmos-database
      base:
        apiVersion: cosmosdb.azure.upbound.io/v1beta1
        kind: SQLDatabase
        spec:
          forProvider: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.databaseName
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.accountNameSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.throughput
          toFieldPath: spec.forProvider.throughput
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name

    # ============================================================
    # 5. Cosmos SQL Container
    # ============================================================
    - name: cosmos-container
      base:
        apiVersion: cosmosdb.azure.upbound.io/v1beta1
        kind: SQLContainer
        spec:
          forProvider:
            indexingPolicy:
              - indexingMode: consistent
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.containerName
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.accountNameSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.databaseName
          toFieldPath: spec.forProvider.databaseNameSelector.matchLabels[databaseName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.partitionKeyPath
          toFieldPath: spec.forProvider.partitionKeyPath
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name

    # ============================================================
    # 6. Cosmos DB Role Assignment (Built-in Data Contributor)
    # ============================================================
    - name: cosmos-role
      base:
        apiVersion: cosmosdb.azure.upbound.io/v1beta1
        kind: SQLRoleAssignment
        spec:
          forProvider:
            # Cosmos DB Built-in Data Contributor
            roleDefinitionId: "00000000-0000-0000-0000-000000000002"
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-cosmos-role"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.accountNameSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.principalIdSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name

    # ============================================================
    # 7. Private Endpoint for Cosmos DB
    # ============================================================
    - name: private-endpoint
      base:
        apiVersion: network.azure.upbound.io/v1beta1
        kind: PrivateEndpoint
        spec:
          forProvider:
            privateServiceConnection:
              - name: cosmos-connection
                isManualConnection: false
                subresourceNames:
                  - Sql
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-cosmos-pe"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.location
          toFieldPath: spec.forProvider.location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.privateEndpointSubnetId
          toFieldPath: spec.forProvider.subnetId
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.privateServiceConnection[0].privateConnectionResourceIdSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name

    # ============================================================
    # 8. Private DNS Zone Group
    # ============================================================
    - name: dns-zone-group
      base:
        apiVersion: network.azure.upbound.io/v1beta1
        kind: PrivateDNSZoneGroup
        spec:
          forProvider:
            privateDnsZoneConfig:
              - name: cosmos-dns
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-dns-group"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.privateEndpointIdSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.privateDnsZoneId
          toFieldPath: spec.forProvider.privateDnsZoneConfig[0].privateDnsZoneId
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name

    # ============================================================
    # 9. Log Analytics Workspace (if monitoring enabled)
    # ============================================================
    - name: log-analytics
      base:
        apiVersion: operationalinsights.azure.upbound.io/v1beta1
        kind: Workspace
        spec:
          forProvider:
            sku: PerGB2018
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-logs"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.location
          toFieldPath: spec.forProvider.location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.monitoring.retentionDays
          toFieldPath: spec.forProvider.retentionInDays
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name

    # ============================================================
    # 10. Application Insights (if monitoring enabled)
    # ============================================================
    - name: app-insights
      base:
        apiVersion: insights.azure.upbound.io/v1beta1
        kind: ApplicationInsights
        spec:
          forProvider:
            applicationType: web
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-appinsights"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.resourceGroup
          toFieldPath: spec.forProvider.resourceGroupName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.location
          toFieldPath: spec.forProvider.location
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.workspaceIdSelector.matchLabels[appName]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef.name
        - type: ToCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.appInsightsName
      connectionDetails:
        - name: appInsightsConnectionString
          fromFieldPath: status.atProvider.connectionString

    # ============================================================
    # 11. Kubernetes Service Account
    # ============================================================
    - name: service-account
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha1
        kind: Object
        spec:
          forProvider:
            manifest:
              apiVersion: v1
              kind: ServiceAccount
              metadata:
                annotations: {}
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.manifest.metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-sa"
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.labels[crossplane.io/claim-namespace]
          toFieldPath: spec.forProvider.manifest.metadata.namespace
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: status.identityClientId
            strategy: string
            string:
              fmt: "%s"
          toFieldPath: spec.forProvider.manifest.metadata.annotations[azure.workload.identity/client-id]

    # ============================================================
    # 12. Kubernetes Deployment with OpenTelemetry Auto-Instrumentation
    # ============================================================
    - name: deployment
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha1
        kind: Object
        spec:
          forProvider:
            manifest:
              apiVersion: apps/v1
              kind: Deployment
              spec:
                replicas: 1
                template:
                  metadata:
                    labels:
                      azure.workload.identity/use: "true"
                    annotations: {}
                  spec:
                    containers:
                      - name: app
                        resources:
                          limits:
                            cpu: "500m"
                            memory: "256Mi"
                          requests:
                            cpu: "100m"
                            memory: "128Mi"
                        env:
                          - name: COSMOS_ENDPOINT
                            value: ""
                          - name: COSMOS_DATABASE
                            value: ""
                          - name: COSMOS_CONTAINER
                            value: ""
                          - name: AZURE_CLIENT_ID
                            value: ""
                          - name: APPLICATIONINSIGHTS_CONNECTION_STRING
                            value: ""
                          - name: OTEL_SERVICE_NAME
                            value: ""
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.manifest.metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.labels[crossplane.io/claim-namespace]
          toFieldPath: spec.forProvider.manifest.metadata.namespace
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.manifest.spec.selector.matchLabels.app
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.manifest.spec.template.metadata.labels.app
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.manifest.spec.template.spec.serviceAccountName
          transforms:
            - type: string
              string:
                fmt: "%s-sa"
        # Image
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: spec.image.repository
              - fromFieldPath: spec.image.tag
            strategy: string
            string:
              fmt: "%s:%s"
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].image
        - type: FromCompositeFieldPath
          fromFieldPath: spec.port
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].ports[0].containerPort
        # Environment variables
        - type: FromCompositeFieldPath
          fromFieldPath: status.cosmosEndpoint
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[0].value
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.databaseName
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[1].value
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cosmos.containerName
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[2].value
        - type: FromCompositeFieldPath
          fromFieldPath: status.identityClientId
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[3].value
        # OpenTelemetry service name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.appName
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[5].value
        # Auto-instrumentation annotation (based on language)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.monitoring.autoInstrumentation.language
          toFieldPath: spec.forProvider.manifest.spec.template.metadata.annotations[instrumentation.opentelemetry.io/inject-sdk]
          transforms:
            - type: map
              map:
                java: "true"
                nodejs: "true"
                python: "true"
                dotnet: "true"
